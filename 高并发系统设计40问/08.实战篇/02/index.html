<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="shortcut icon" type="image/x-icon" href="/logo.png" />
    <link rel="stylesheet" href="/blog-two/umi.css" />
    <script>
      window.routerBase = "/blog-two";
    </script>
    <script>
      //! umi version: 3.5.17
    </script>
    <script>
      !(function () {
        var e = localStorage.getItem("dumi:prefers-color"),
          t = window.matchMedia("(prefers-color-scheme: dark)").matches,
          r = ["light", "dark", "auto"];
        document.documentElement.setAttribute(
          "data-prefers-color",
          e === r[2] ? (t ? r[1] : r[0]) : r.indexOf(e) > -1 ? e : r[0]
        );
      })();
    </script>
    <title>38 | 计数系统设计（二）：50万QPS下如何设计未读数系统？</title>
  </head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-route="/高并发系统设计40问/08.实战篇/02" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;/logo.png&#x27;)" href="/blog-two/">大师兄</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><span>后端开发<ul><li><a href="/blog-two/go语言核心36讲">go语言核心36讲</a></li><li><a href="/blog-two/go并发编程实战">go并发编程实战</a></li><li><a href="/blog-two/零基础学python">零基础学python</a></li><li><a href="/blog-two/redis核心技术与实战">redis核心技术与实战</a></li><li><a href="/blog-two/redis源码剖析与实战">redis源码剖析与实战</a></li><li><a href="/blog-two/陈天rust编程第一课">陈天rust编程第一课</a></li><li><a href="/blog-two/tonybaigo语言第一课">tonybaigo语言第一课</a></li><li><a href="/blog-two/深入c语言和程序运行原理">深入c语言和程序运行原理</a></li></ul></span><span>架构师<ul><li><a href="/blog-two/持续交付36讲">持续交付36讲</a></li><li><a href="/blog-two/容器实战高手课">容器实战高手课</a></li><li><a href="/blog-two/ddd实战课">ddd实战课</a></li><li><a href="/blog-two/设计模式之美">设计模式之美</a></li><li><a href="/blog-two/devops实战笔记">devops实战笔记</a></li><li><a href="/blog-two/架构实战案例解析">架构实战案例解析</a></li><li><a href="/blog-two/许式伟的架构课">许式伟的架构课</a></li><li><a aria-current="page" class="active" href="/blog-two/高并发系统设计40问">高并发系统设计40问</a></li><li><a href="/blog-two/深入剖析kubernetes">深入剖析kubernetes</a></li><li><a href="/blog-two/说透中台">说透中台</a></li><li><a href="/blog-two/消息队列进阶">消息队列进阶</a></li><li><a href="/blog-two/mysql实战45讲">mysql实战45讲</a></li><li><a href="/blog-two/openresty从入门到实战">openresty从入门到实战</a></li><li><a href="/blog-two/赵成的运维体系管理课">赵成的运维体系管理课</a></li><li><a href="/blog-two/性能测试实战30讲">性能测试实战30讲</a></li><li><a href="/blog-two/安全攻防技能30讲">安全攻防技能30讲</a></li><li><a href="/blog-two/从0开始学架构">从0开始学架构</a></li><li><a href="/blog-two/vim实用技巧必知必会">vim实用技巧必知必会</a></li><li><a href="/blog-two/如何落地业务建模">如何落地业务建模</a></li><li><a href="/blog-two/技术与商业案例解读">技术与商业案例解读</a></li><li><a href="/blog-two/说透数字化转型">说透数字化转型</a></li><li><a href="/blog-two/遗留系统现代化实战">遗留系统现代化实战</a></li></ul></span><span>管理<ul><li><a href="/blog-two/技术管理实战36讲">技术管理实战36讲</a></li><li><a href="/blog-two/程序员进阶攻略">程序员进阶攻略</a></li><li><a href="/blog-two/项目管理实战课">项目管理实战课</a></li><li><a href="/blog-two/技术面试官识人手册">技术面试官识人手册</a></li><li><a href="/blog-two/技术领导力实战笔记">技术领导力实战笔记</a></li><li><a href="/blog-two/朱赟的技术管理">朱赟的技术管理</a></li></ul></span><span>工作生活<ul><li><a href="/blog-two/10x程序员工作法">10x程序员工作法</a></li><li><a href="/blog-two/python自动化办公实战课">python自动化办公实战课</a></li><li><a href="/blog-two/人人都用得上的写作课">人人都用得上的写作课</a></li><li><a href="/blog-two/体验设计案例课">体验设计案例课</a></li><li><a href="/blog-two/用户体验设计实战课">用户体验设计实战课</a></li><li><a href="/blog-two/程序员的个人财富课">程序员的个人财富课</a></li><li><a href="/blog-two/程序员进阶攻略">程序员进阶攻略</a></li><li><a href="/blog-two/职场求生攻略">职场求生攻略</a></li><li><a href="/blog-two/讲好故事">讲好故事</a></li><li><a href="/blog-two/跟着高手学复盘">跟着高手学复盘</a></li></ul></span><span>杂谈</span><div class="__dumi-default-navbar-tool"><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "></div></div></div></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;/logo.png&#x27;)" href="/blog-two/"></a><h1>大师兄</h1><p></p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li>后端开发<ul><li><a href="/blog-two/go语言核心36讲">go语言核心36讲</a></li><li><a href="/blog-two/go并发编程实战">go并发编程实战</a></li><li><a href="/blog-two/零基础学python">零基础学python</a></li><li><a href="/blog-two/redis核心技术与实战">redis核心技术与实战</a></li><li><a href="/blog-two/redis源码剖析与实战">redis源码剖析与实战</a></li><li><a href="/blog-two/陈天rust编程第一课">陈天rust编程第一课</a></li><li><a href="/blog-two/tonybaigo语言第一课">tonybaigo语言第一课</a></li><li><a href="/blog-two/深入c语言和程序运行原理">深入c语言和程序运行原理</a></li></ul></li><li>架构师<ul><li><a href="/blog-two/持续交付36讲">持续交付36讲</a></li><li><a href="/blog-two/容器实战高手课">容器实战高手课</a></li><li><a href="/blog-two/ddd实战课">ddd实战课</a></li><li><a href="/blog-two/设计模式之美">设计模式之美</a></li><li><a href="/blog-two/devops实战笔记">devops实战笔记</a></li><li><a href="/blog-two/架构实战案例解析">架构实战案例解析</a></li><li><a href="/blog-two/许式伟的架构课">许式伟的架构课</a></li><li><a aria-current="page" class="active" href="/blog-two/高并发系统设计40问">高并发系统设计40问</a></li><li><a href="/blog-two/深入剖析kubernetes">深入剖析kubernetes</a></li><li><a href="/blog-two/说透中台">说透中台</a></li><li><a href="/blog-two/消息队列进阶">消息队列进阶</a></li><li><a href="/blog-two/mysql实战45讲">mysql实战45讲</a></li><li><a href="/blog-two/openresty从入门到实战">openresty从入门到实战</a></li><li><a href="/blog-two/赵成的运维体系管理课">赵成的运维体系管理课</a></li><li><a href="/blog-two/性能测试实战30讲">性能测试实战30讲</a></li><li><a href="/blog-two/安全攻防技能30讲">安全攻防技能30讲</a></li><li><a href="/blog-two/从0开始学架构">从0开始学架构</a></li><li><a href="/blog-two/vim实用技巧必知必会">vim实用技巧必知必会</a></li><li><a href="/blog-two/如何落地业务建模">如何落地业务建模</a></li><li><a href="/blog-two/技术与商业案例解读">技术与商业案例解读</a></li><li><a href="/blog-two/说透数字化转型">说透数字化转型</a></li><li><a href="/blog-two/遗留系统现代化实战">遗留系统现代化实战</a></li></ul></li><li>管理<ul><li><a href="/blog-two/技术管理实战36讲">技术管理实战36讲</a></li><li><a href="/blog-two/程序员进阶攻略">程序员进阶攻略</a></li><li><a href="/blog-two/项目管理实战课">项目管理实战课</a></li><li><a href="/blog-two/技术面试官识人手册">技术面试官识人手册</a></li><li><a href="/blog-two/技术领导力实战笔记">技术领导力实战笔记</a></li><li><a href="/blog-two/朱赟的技术管理">朱赟的技术管理</a></li></ul></li><li>工作生活<ul><li><a href="/blog-two/10x程序员工作法">10x程序员工作法</a></li><li><a href="/blog-two/python自动化办公实战课">python自动化办公实战课</a></li><li><a href="/blog-two/人人都用得上的写作课">人人都用得上的写作课</a></li><li><a href="/blog-two/体验设计案例课">体验设计案例课</a></li><li><a href="/blog-two/用户体验设计实战课">用户体验设计实战课</a></li><li><a href="/blog-two/程序员的个人财富课">程序员的个人财富课</a></li><li><a href="/blog-two/程序员进阶攻略">程序员进阶攻略</a></li><li><a href="/blog-two/职场求生攻略">职场求生攻略</a></li><li><a href="/blog-two/讲好故事">讲好故事</a></li><li><a href="/blog-two/跟着高手学复盘">跟着高手学复盘</a></li></ul></li><li>杂谈</li></ul><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "><button title="Dark theme" class="__dumi-default-dark-moon "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3854" width="22" height="22"><path d="M991.816611 674.909091a69.166545 69.166545 0 0 0-51.665455-23.272727 70.795636 70.795636 0 0 0-27.438545 5.585454A415.674182 415.674182 0 0 1 754.993338 698.181818c-209.594182 0-393.472-184.785455-393.472-395.636363 0-52.363636 38.539636-119.621818 69.515637-173.614546 4.887273-8.610909 9.634909-16.756364 14.103272-24.901818A69.818182 69.818182 0 0 0 384.631156 0a70.842182 70.842182 0 0 0-27.438545 5.585455C161.678429 90.298182 14.362065 307.898182 14.362065 512c0 282.298182 238.824727 512 532.38691 512a522.286545 522.286545 0 0 0 453.957818-268.334545A69.818182 69.818182 0 0 0 991.816611 674.909091zM546.679156 954.181818c-248.785455 0-462.941091-192-462.941091-442.181818 0-186.647273 140.637091-372.829091 300.939637-442.181818-36.817455 65.629091-92.578909 151.970909-92.578909 232.727273 0 250.181818 214.109091 465.454545 462.917818 465.454545a488.331636 488.331636 0 0 0 185.181091-46.545455 453.003636 453.003636 0 0 1-393.565091 232.727273z m103.656728-669.323636l-14.266182 83.781818a34.909091 34.909091 0 0 0 50.362182 36.770909l74.775272-39.563636 74.752 39.563636a36.142545 36.142545 0 0 0 16.174546 3.956364 34.909091 34.909091 0 0 0 34.210909-40.727273l-14.289455-83.781818 60.509091-59.345455a35.025455 35.025455 0 0 0-19.223272-59.578182l-83.61891-12.101818-37.376-76.101818a34.56 34.56 0 0 0-62.254545 0l-37.376 76.101818-83.618909 12.101818a34.909091 34.909091 0 0 0-19.246546 59.578182z m70.423272-64.698182a34.280727 34.280727 0 0 0 26.135273-19.083636l14.312727-29.090909 14.336 29.090909a34.257455 34.257455 0 0 0 26.135273 19.083636l32.046546 4.887273-23.272728 22.574545a35.234909 35.234909 0 0 0-10.007272 30.952727l5.46909 32.116364-28.625454-15.127273a34.490182 34.490182 0 0 0-32.302546 0l-28.695272 15.127273 5.469091-32.116364a35.141818 35.141818 0 0 0-9.984-30.952727l-23.272728-22.574545z" p-id="3855"></path></svg></button><button title="Light theme" class="__dumi-default-dark-sun "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4026" width="22" height="22"><path d="M915.2 476.16h-43.968c-24.704 0-44.736 16-44.736 35.84s20.032 35.904 44.736 35.904H915.2c24.768 0 44.8-16.064 44.8-35.904s-20.032-35.84-44.8-35.84zM512 265.6c-136.704 0-246.464 109.824-246.464 246.4 0 136.704 109.76 246.464 246.464 246.464S758.4 648.704 758.4 512c0-136.576-109.696-246.4-246.4-246.4z m0 425.6c-99.008 0-179.2-80.128-179.2-179.2 0-98.944 80.192-179.2 179.2-179.2S691.2 413.056 691.2 512c0 99.072-80.192 179.2-179.2 179.2zM197.44 512c0-19.84-19.136-35.84-43.904-35.84H108.8c-24.768 0-44.8 16-44.8 35.84s20.032 35.904 44.8 35.904h44.736c24.768 0 43.904-16.064 43.904-35.904zM512 198.464c19.776 0 35.84-20.032 35.84-44.8v-44.8C547.84 84.032 531.84 64 512 64s-35.904 20.032-35.904 44.8v44.8c0 24.768 16.128 44.864 35.904 44.864z m0 627.136c-19.776 0-35.904 20.032-35.904 44.8v44.736C476.096 940.032 492.16 960 512 960s35.84-20.032 35.84-44.8v-44.736c0-24.768-16.064-44.864-35.84-44.864z m329.92-592.832c17.472-17.536 20.288-43.072 6.4-57.024-14.016-14.016-39.488-11.2-57.024 6.336-4.736 4.864-26.496 26.496-31.36 31.36-17.472 17.472-20.288 43.008-6.336 57.024 13.952 14.016 39.488 11.2 57.024-6.336 4.8-4.864 26.496-26.56 31.296-31.36zM213.376 759.936c-4.864 4.8-26.56 26.624-31.36 31.36-17.472 17.472-20.288 42.944-6.4 56.96 14.016 13.952 39.552 11.2 57.024-6.336 4.8-4.736 26.56-26.496 31.36-31.36 17.472-17.472 20.288-43.008 6.336-56.96-14.016-13.952-39.552-11.072-56.96 6.336z m19.328-577.92c-17.536-17.536-43.008-20.352-57.024-6.336-14.08 14.016-11.136 39.488 6.336 57.024 4.864 4.864 26.496 26.56 31.36 31.424 17.536 17.408 43.008 20.288 56.96 6.336 14.016-14.016 11.264-39.488-6.336-57.024-4.736-4.864-26.496-26.56-31.296-31.424z m527.168 628.608c4.864 4.864 26.624 26.624 31.36 31.424 17.536 17.408 43.072 20.224 57.088 6.336 13.952-14.016 11.072-39.552-6.4-57.024-4.864-4.8-26.56-26.496-31.36-31.36-17.472-17.408-43.072-20.288-57.024-6.336-13.952 14.016-11.008 39.488 6.336 56.96z" p-id="4027"></path></svg></button><button title="Default to system" class="__dumi-default-dark-auto "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="11002" width="22" height="22"><path d="M127.658667 492.885333c0-51.882667 10.24-101.717333 30.378666-149.162666s47.786667-88.064 81.92-122.538667 75.093333-61.781333 122.538667-81.92 96.938667-30.378667 149.162667-30.378667 101.717333 10.24 149.162666 30.378667 88.405333 47.786667 122.88 81.92 61.781333 75.093333 81.92 122.538667 30.378667 96.938667 30.378667 149.162666-10.24 101.717333-30.378667 149.162667-47.786667 88.405333-81.92 122.88-75.093333 61.781333-122.88 81.92-97.28 30.378667-149.162666 30.378667-101.717333-10.24-149.162667-30.378667-88.064-47.786667-122.538667-81.92-61.781333-75.093333-81.92-122.88-30.378667-96.938667-30.378666-149.162667z m329.045333 0c0 130.048 13.994667 244.394667 41.984 343.381334h12.970667c46.762667 0 91.136-9.216 133.461333-27.306667s78.848-42.666667 109.568-73.386667 54.954667-67.242667 73.386667-109.568 27.306667-86.698667 27.306666-133.461333c0-46.421333-9.216-90.794667-27.306666-133.12s-42.666667-78.848-73.386667-109.568-67.242667-54.954667-109.568-73.386667-86.698667-27.306667-133.461333-27.306666h-11.605334c-28.672 123.562667-43.349333 237.909333-43.349333 343.722666z" p-id="11003"></path></svg></button></div></div></div><ul class="__dumi-default-menu-list"><li><a href="/blog-two/高并发系统设计40问">高并发系统设计40问</a></li><li><a href="/blog-two/高并发系统设计40问/01.开篇词">01.开篇词</a><ul><li><a href="/blog-two/高并发系统设计40问/01.开篇词/01"><span>开篇词 | 为什么你要学习高并发系统设计？</span></a></li></ul></li><li><a href="/blog-two/高并发系统设计40问/02.基础篇">02.基础篇</a><ul><li><a href="/blog-two/高并发系统设计40问/02.基础篇/01"><span>01 | 高并发系统：它的通用设计方法是什么？</span></a></li><li><a href="/blog-two/高并发系统设计40问/02.基础篇/02"><span>02 | 架构分层：我们为什么一定要这么做？</span></a></li><li><a href="/blog-two/高并发系统设计40问/02.基础篇/03"><span>03 | 系统设计目标（一）：如何提升系统性能？</span></a></li><li><a href="/blog-two/高并发系统设计40问/02.基础篇/04"><span>04 | 系统设计目标（二）：系统怎样做到高可用？</span></a></li><li><a href="/blog-two/高并发系统设计40问/02.基础篇/05"><span>05 | 系统设计目标（三）：如何让系统易于扩展？</span></a></li><li><a href="/blog-two/高并发系统设计40问/02.基础篇/06"><span>06 | 面试现场第一期：当问到组件实现原理时，面试官是在刁难你吗？</span></a></li></ul></li><li><a href="/blog-two/高并发系统设计40问/03.演进篇·数据库篇">03.演进篇·数据库篇</a><ul><li><a href="/blog-two/高并发系统设计40问/03.演进篇·数据库篇/01"><span>07 | 池化技术：如何减少频繁创建数据库连接的性能损耗？</span></a></li><li><a href="/blog-two/高并发系统设计40问/03.演进篇·数据库篇/02"><span>08 | 数据库优化方案（一）：查询请求增加时，如何做主从分离？</span></a></li><li><a href="/blog-two/高并发系统设计40问/03.演进篇·数据库篇/03"><span>09 | 数据库优化方案（二）：写入数据量增加时，如何实现分库分表？</span></a></li><li><a href="/blog-two/高并发系统设计40问/03.演进篇·数据库篇/04"><span>10 | 发号器：如何保证分库分表后ID的全局唯一性？</span></a></li><li><a href="/blog-two/高并发系统设计40问/03.演进篇·数据库篇/05"><span>11 |   NoSQL：在高并发场景下，数据库和NoSQL如何做到互补？</span></a></li></ul></li><li><a href="/blog-two/高并发系统设计40问/04.演进篇·缓存篇">04.演进篇·缓存篇</a><ul><li><a href="/blog-two/高并发系统设计40问/04.演进篇·缓存篇/01"><span>12 | 缓存：数据库成为瓶颈后，动态数据的查询要如何加速？</span></a></li><li><a href="/blog-two/高并发系统设计40问/04.演进篇·缓存篇/02"><span>13 | 缓存的使用姿势（一）：如何选择缓存的读写策略？</span></a></li><li><a href="/blog-two/高并发系统设计40问/04.演进篇·缓存篇/03"><span>14 | 缓存的使用姿势（二）：缓存如何做到高可用？</span></a></li><li><a href="/blog-two/高并发系统设计40问/04.演进篇·缓存篇/04"><span>15 | 缓存的使用姿势（三）：缓存穿透了怎么办？</span></a></li><li><a href="/blog-two/高并发系统设计40问/04.演进篇·缓存篇/05"><span>16 | CDN：静态资源如何加速？</span></a></li><li><a href="/blog-two/高并发系统设计40问/04.演进篇·缓存篇/06"><span>加餐 | 数据的迁移应该如何做？</span></a></li></ul></li><li><a href="/blog-two/高并发系统设计40问/05.演进篇·消息队列篇">05.演进篇·消息队列篇</a><ul><li><a href="/blog-two/高并发系统设计40问/05.演进篇·消息队列篇/01"><span>17 | 消息队列：秒杀时如何处理每秒上万次的下单请求？</span></a></li><li><a href="/blog-two/高并发系统设计40问/05.演进篇·消息队列篇/02"><span>18 | 消息投递：如何保证消息仅仅被消费一次？</span></a></li><li><a href="/blog-two/高并发系统设计40问/05.演进篇·消息队列篇/03"><span>19 | 消息队列：如何降低消息队列系统中消息的延迟？</span></a></li><li><a href="/blog-two/高并发系统设计40问/05.演进篇·消息队列篇/04"><span>20 | 面试现场第二期：当问到项目经历时，面试官究竟想要了解什么？</span></a></li><li><a href="/blog-two/高并发系统设计40问/05.演进篇·消息队列篇/05"><span>用户故事 | 从“心”出发，我还有无数个可能</span></a></li><li><a href="/blog-two/高并发系统设计40问/05.演进篇·消息队列篇/06"><span>期中测试 | 10道高并发系统设计题目自测</span></a></li></ul></li><li><a href="/blog-two/高并发系统设计40问/06.演进篇·分布式服务篇">06.演进篇·分布式服务篇</a><ul><li><a href="/blog-two/高并发系统设计40问/06.演进篇·分布式服务篇/01"><span>21 | 系统架构：每秒1万次请求的系统要做服务化拆分吗？</span></a></li><li><a href="/blog-two/高并发系统设计40问/06.演进篇·分布式服务篇/02"><span>22 | 微服务架构：微服务化后系统架构要如何改造？</span></a></li><li><a href="/blog-two/高并发系统设计40问/06.演进篇·分布式服务篇/03"><span>23 | RPC框架：10万QPS下如何实现毫秒级的服务调用？</span></a></li><li><a href="/blog-two/高并发系统设计40问/06.演进篇·分布式服务篇/04"><span>24 | 注册中心：分布式系统如何寻址？</span></a></li><li><a href="/blog-two/高并发系统设计40问/06.演进篇·分布式服务篇/05"><span>25 | 分布式Trace：横跨几十个分布式组件的慢请求要如何排查？</span></a></li><li><a href="/blog-two/高并发系统设计40问/06.演进篇·分布式服务篇/06"><span>26 | 负载均衡：怎样提升系统的横向扩展能力？</span></a></li><li><a href="/blog-two/高并发系统设计40问/06.演进篇·分布式服务篇/07"><span>27 | API网关：系统的门面要如何做呢？</span></a></li><li><a href="/blog-two/高并发系统设计40问/06.演进篇·分布式服务篇/08"><span>28 | 多机房部署：跨地域的分布式系统如何做？</span></a></li><li><a href="/blog-two/高并发系统设计40问/06.演进篇·分布式服务篇/09"><span>29 | Service Mesh：如何屏蔽服务化系统的服务治理细节？</span></a></li></ul></li><li><a href="/blog-two/高并发系统设计40问/07.演进篇·维护篇">07.演进篇·维护篇</a><ul><li><a href="/blog-two/高并发系统设计40问/07.演进篇·维护篇/01"><span>30 | 给系统加上眼睛：服务端监控要怎么做？</span></a></li><li><a href="/blog-two/高并发系统设计40问/07.演进篇·维护篇/02"><span>31 | 应用性能管理：用户的使用体验应该如何监控？</span></a></li><li><a href="/blog-two/高并发系统设计40问/07.演进篇·维护篇/03"><span>32 |  压力测试：怎样设计全链路压力测试平台？</span></a></li><li><a href="/blog-two/高并发系统设计40问/07.演进篇·维护篇/04"><span>33 | 配置管理：成千上万的配置项要如何管理？</span></a></li><li><a href="/blog-two/高并发系统设计40问/07.演进篇·维护篇/05"><span>34 | 降级熔断：如何屏蔽非核心系统故障的影响？</span></a></li><li><a href="/blog-two/高并发系统设计40问/07.演进篇·维护篇/06"><span>35 |  流量控制：高并发系统中我们如何操纵流量？</span></a></li><li><a href="/blog-two/高并发系统设计40问/07.演进篇·维护篇/07"><span>36 | 面试现场第三期：你要如何准备一场技术面试呢？</span></a></li></ul></li><li><a aria-current="page" class="active" href="/blog-two/高并发系统设计40问/08.实战篇">08.实战篇</a><ul><li><a href="/blog-two/高并发系统设计40问/08.实战篇/01"><span>37 | 计数系统设计（一）：面对海量数据的计数器要如何做？</span></a></li><li><a aria-current="page" class="active" href="/blog-two/高并发系统设计40问/08.实战篇/02"><span>38 | 计数系统设计（二）：50万QPS下如何设计未读数系统？</span></a></li><li><a href="/blog-two/高并发系统设计40问/08.实战篇/03"><span>39 | 信息流设计（一）：通用信息流系统的推模式要如何做？</span></a></li><li><a href="/blog-two/高并发系统设计40问/08.实战篇/04"><span>40 |  信息流设计（二）：通用信息流系统的拉模式要如何做？</span></a></li></ul></li><li><a href="/blog-two/高并发系统设计40问/09.结束语">09.结束语</a><ul><li><a href="/blog-two/高并发系统设计40问/09.结束语/01"><span>结束语 | 学不可以已</span></a></li><li><a href="/blog-two/高并发系统设计40问/09.结束语/02"><span>结课问卷获奖用户名单</span></a></li><li><a href="/blog-two/高并发系统设计40问/09.结束语/03"><span>春节特别策划 | 高并发下如何发现和排查问题？</span></a></li><li><a href="/blog-two/高并发系统设计40问/09.结束语/04"><span>春节特别策划 | 我们如何准备抵抗流量峰值？</span></a></li></ul></li><li><a href="/blog-two/高并发系统设计40问/10.结课测试">10.结课测试</a><ul><li><a href="/blog-two/高并发系统设计40问/10.结课测试/01"><span>结课测试 | 高并发系统设计的相关知识，你都掌握了吗？</span></a></li></ul></li><li><a href="/blog-two/高并发系统设计40问/summary">高并发系统设计40问</a></li></ul></div></div><ul role="slug-list" class="__dumi-default-layout-toc"><li title="系统通知的未读数要如何设计" data-depth="2"><a href="/blog-two/高并发系统设计40问/08.实战篇/02#系统通知的未读数要如何设计"><span>系统通知的未读数要如何设计</span></a></li><li title="如何为信息流的未读数设计方案" data-depth="2"><a href="/blog-two/高并发系统设计40问/08.实战篇/02#如何为信息流的未读数设计方案"><span>如何为信息流的未读数设计方案</span></a></li><li title="课程小结" data-depth="2"><a href="/blog-two/高并发系统设计40问/08.实战篇/02#课程小结"><span>课程小结</span></a></li><li title="一课一思" data-depth="2"><a href="/blog-two/高并发系统设计40问/08.实战篇/02#一课一思"><span>一课一思</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h1 id="38--计数系统设计二50万qps下如何设计未读数系统"><a aria-hidden="true" tabindex="-1" href="/blog-two/高并发系统设计40问/08.实战篇/02#38--计数系统设计二50万qps下如何设计未读数系统"><span class="icon icon-link"></span></a>38 | 计数系统设计（二）：50万QPS下如何设计未读数系统？</h1><p>你好，我是唐扬。</p><p>在上一节课中我带你了解了如何设计一套支撑高并发访问和存储大数据量的通用计数系统，我们通过缓存技术、消息队列技术以及对于Redis的深度改造，就能够支撑万亿级计数数据存储以及每秒百万级别读取请求了。然而有一类特殊的计数并不能完全使用我们提到的方案，那就是未读数。</p><p>未读数也是系统中一个常见的模块，以微博系统为例，你可看到有多个未读计数的场景，比如：</p><ul><li>当有人@你、评论你、给你的博文点赞或者给你发送私信的时候，你会收到相应的未读提醒；</li><li>在早期的微博版本中有系统通知的功能，也就是系统会给全部用户发送消息，通知用户有新的版本或者有一些好玩的运营活动，如果用户没有看，系统就会给他展示有多少条未读的提醒。</li><li>我们在浏览信息流的时候，如果长时间没有刷新页面，那么信息流上方就会提示你在这段时间有多少条信息没有看。</li></ul><p>那当你遇到第一个需求时，要如何记录未读数呢？其实，这个需求可以用上节课提到的通用计数系统来实现，因为二者的场景非常相似。</p><p>你可以在计数系统中增加一块儿内存区域，以用户ID为Key存储多个未读数，当有人@ 你时，增加你的未读@的计数；当有人评论你时，增加你的未读评论的计数，以此类推。当你点击了未读数字进入通知页面，查看@ 你或者评论你的消息时，重置这些未读计数为零。相信通过上一节课的学习，你已经非常熟悉这一类系统的设计了，所以我不再赘述。</p><p>那么系统通知的未读数是如何实现的呢？我们能用通用计数系统实现吗？答案是不能的，因为会出现一些问题。</p><h2 id="系统通知的未读数要如何设计"><a aria-hidden="true" tabindex="-1" href="/blog-two/高并发系统设计40问/08.实战篇/02#系统通知的未读数要如何设计"><span class="icon icon-link"></span></a>系统通知的未读数要如何设计</h2><p>来看具体的例子。假如你的系统中只有A、B、C三个用户，那么你可以在通用计数系统中增加一块儿内存区域，并且以用户ID为Key来存储这三个用户的未读通知数据，当系统发送一个新的通知时，我们会循环给每一个用户的未读数加1，这个处理逻辑的伪代码就像下面这样：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">List&lt;Long&gt; userIds = getAllUserIds();</span></div><div class="token-line"><span class="token plain">    for(Long id : userIds) {</span></div><div class="token-line"><span class="token plain">      incrUnreadCount(id);</span></div><div class="token-line"><span class="token plain">    }</span></div></pre></div><p>这样看来，似乎简单可行，但随着系统中的用户越来越多，这个方案存在两个致命的问题。</p><p>首先，获取全量用户就是一个比较耗时的操作，相当于对用户库做一次全表的扫描，这不仅会对数据库造成很大的压力，而且查询全量用户数据的响应时间是很长的，对于在线业务来说是难以接受的。如果你的用户库已经做了分库分表，那么就要扫描所有的库表，响应时间就更长了。<strong>不过有一个折中的方法，</strong> 那就是在发送系统通知之前，先从线下的数据仓库中获取全量的用户ID，并且存储在一个本地的文件中，然后再轮询所有的用户ID，给这些用户增加未读计数。</p><p>这似乎是一个可行的技术方案，然而它给所有人增加未读计数，会消耗非常长的时间。你计算一下，假如你的系统中有一个亿的用户，给一个用户增加未读数需要消耗1ms，那么给所有人都增加未读计数就需要100000000 * 1 /1000 = 100000秒，也就是超过一天的时间；即使你启动100个线程并发的设置，也需要十几分钟的时间才能完成，而用户很难接受这么长的延迟时间。</p><p>另外，使用这种方式需要给系统中的每一个用户都记一个未读数的值，而在系统中，活跃用户只是很少的一部分，大部分的用户是不活跃的，甚至从来没有打开过系统通知，为这些用户记录未读数显然是一种浪费。</p><p>通过上面的内容，你可以知道为什么我们不能用通用计数系统实现系统通知未读数了吧？那正确的做法是什么呢？</p><p>要知道，系统通知实际上是存储在一个大的列表中的，这个列表对所有用户共享，也就是所有人看到的都是同一份系统通知的数据。不过不同的人最近看到的消息不同，所以每个人会有不同的未读数。因此，你可以记录一下在这个列表中每个人看过最后一条消息的ID，然后统计这个ID之后有多少条消息，这就是未读数了。</p><p><img src="https://static001.geekbang.org/resource/image/a5/10/a5f0b6776246dc6b4c7e96c72d74a210.jpg" alt=""/></p><p>这个方案在实现时有这样几个关键点：</p><ul><li>用户访问系统通知页面需要设置未读数为0，我们需要将用户最近看过的通知ID设置为最新的一条系统通知ID；</li><li>如果最近看过的通知ID为空，则认为是一个新的用户，返回未读数为0；</li><li>对于非活跃用户，比如最近一个月都没有登录和使用过系统的用户，可以把用户最近看过的通知ID清空，节省内存空间。</li></ul><p><strong>这是一种比较通用的方案，既节省内存，又能尽量减少获取未读数的延迟。</strong> 这个方案适用的另一个业务场景是全量用户打点的场景，比如像下面这张微博截图中的红点。<br/><img src="https://static001.geekbang.org/resource/image/ae/3f/ae6a5e9e04be08d18c493729458d543f.jpg" alt=""/></p><p>这个红点和系统通知类似，也是一种通知全量用户的手段，如果逐个通知用户，延迟也是无法接受的。<strong>因此你可以采用和系统通知类似的方案。</strong></p><p>首先，我们为每一个用户存储一个时间戳，代表最近点过这个红点的时间，用户点了红点，就把这个时间戳设置为当前时间；然后，我们也记录一个全局的时间戳，这个时间戳标识最新的一次打点时间，如果你在后台操作给全体用户打点，就更新这个时间戳为当前时间。而我们在判断是否需要展示红点时，只需要判断用户的时间戳和全局时间戳的大小，如果用户时间戳小于全局时间戳，代表在用户最后一次点击红点之后又有新的红点推送，那么就要展示红点，反之，就不展示红点了。</p><p><img src="https://static001.geekbang.org/resource/image/55/98/553e7da158a7eca56369e23c9b672898.jpg" alt=""/></p><p>这两个场景的共性是全部用户共享一份有限的存储数据，每个人只记录自己在这份存储中的偏移量，就可以得到未读数了。</p><p>你可以看到，系统消息未读的实现方案不是很复杂，它通过设计避免了操作全量数据未读数，如果你的系统中有这种打红点的需求，那我建议你可以结合实际工作灵活使用上述方案。</p><p>最后一个需求关注的是微博信息流的未读数，在现在的社交系统中，关注关系已经成为标配的功能，而基于关注关系的信息流也是一种非常重要的信息聚合方式，因此，如何设计信息流的未读数系统就成了你必须面对的一个问题。</p><h2 id="如何为信息流的未读数设计方案"><a aria-hidden="true" tabindex="-1" href="/blog-two/高并发系统设计40问/08.实战篇/02#如何为信息流的未读数设计方案"><span class="icon icon-link"></span></a>如何为信息流的未读数设计方案</h2><p>信息流的未读数之所以复杂主要有这样几点原因。</p><ul><li><p>首先，微博的信息流是基于关注关系的，未读数也是基于关注关系的，就是说，你关注的人发布了新的微博，那么你作为粉丝未读数就要增加1。如果微博用户都是像我这样只有几百粉丝的“小透明”就简单了，你发微博的时候系统给你粉丝的未读数增加1不是什么难事儿。但是对于一些动辄几千万甚至上亿粉丝的微博大V就麻烦了，增加未读数可能需要几个小时。假设你是杨幂的粉丝，想了解她实时发布的博文，那么如果当她发布博文几个小时之后，你才收到提醒，这显然是不能接受的。所以未读数的延迟是你在设计方案时首先要考虑的内容。</p></li><li><p>其次，信息流未读数请求量极大、并发极高，这是因为接口是客户端轮询请求的，不是用户触发的。也就是说，用户即使打开微博客户端什么都不做，这个接口也会被请求到。在几年前，请求未读数接口的量级就已经接近每秒50万次，这几年随着微博量级的增长，请求量也变得更高。而作为微博的非核心接口，我们不太可能使用大量的机器来抗未读数请求，因此，如何使用有限的资源来支撑如此高的流量是这个方案的难点。</p></li><li><p>最后，它不像系统通知那样有共享的存储，因为每个人关注的人不同，信息流的列表也就不同，所以也就没办法采用系统通知未读数的方案。</p></li></ul><p>那要如何设计能够承接每秒几十万次请求的信息流未读数系统呢？你可以这样做：</p><ul><li>首先，在通用计数器中记录每一个用户发布的博文数；</li><li>然后在Redis或者Memcached中记录一个人所有关注人的博文数快照，当用户点击未读消息重置未读数为0时，将他关注所有人的博文数刷新到快照中；</li><li>这样，他关注所有人的博文总数减去快照中的博文总数就是他的信息流未读数。</li></ul><p><img src="https://static001.geekbang.org/resource/image/a5/8a/a563b121ae1147a2d877a7bb14c9658a.jpg" alt=""/></p><p>假如用户A，像上图这样关注了用户B、C、D，其中B发布的博文数是10，C发布的博文数是8，D发布的博文数是14，而在用户A最近一次查看未读消息时，记录在快照中的这三个用户的博文数分别是6、7、12，因此用户A的未读数就是（10-6）+（8-7）+（14-12）=7。</p><p>这个方案设计简单，并且是全内存操作，性能足够好，能够支撑比较高的并发，事实上微博团队仅仅用16台普通的服务器就支撑了每秒接近50万次的请求，这就足以证明这个方案的性能有多出色，因此，它完全能够满足信息流未读数的需求。</p><p>当然了这个方案也有一些缺陷，比如说快照中需要存储关注关系，如果关注关系变更的时候更新不及时，那么就会造成未读数不准确；快照采用的是全缓存存储，如果缓存满了就会剔除一些数据，那么被剔除用户的未读数就变为0了。但是好在用户对于未读数的准确度要求不高（未读10条还是11条，其实用户有时候看不出来），因此，这些缺陷也是可以接受的。</p><p>通过分享未读数系统设计这个案例，我想给你一些建议：</p><ol><li>缓存是提升系统性能和抵抗大并发量的神器，像是微博信息流未读数这么大的量级我们仅仅使用十几台服务器就可以支撑，这全都是缓存的功劳；</li><li>要围绕系统设计的关键困难点想解决办法，就像我们解决系统通知未读数的延迟问题一样；</li><li>合理分析业务场景，明确哪些是可以权衡的，哪些是不行的，会对你的系统设计增益良多，比如对于长久不登录用户，我们就会记录未读数为0，通过这样的权衡，可以极大地减少内存的占用，减少成本。</li></ol><h2 id="课程小结"><a aria-hidden="true" tabindex="-1" href="/blog-two/高并发系统设计40问/08.实战篇/02#课程小结"><span class="icon icon-link"></span></a>课程小结</h2><p>以上就是本节课的全部内容了，本节课我带你了解了未读数系统的设计，这里你需要了解的重点是：</p><ol><li>评论未读、@未读、赞未读等一对一关系的未读数可以使用上节课讲到的通用计数方案来解决；</li><li>在系统通知未读、全量用户打点等存在有限的共享存储的场景下，可以通过记录用户上次操作的时间或者偏移量，来实现未读方案；</li><li>最后，信息流未读方案最为复杂，采用的是记录用户博文数快照的方式。</li></ol><p>这里你可以看到，这三类需求虽然都和未读数有关，但是需求场景不同、对于量级的要求不同，设计出来的方案也就不同。因此，就像我刚刚提到的样子，你在做方案设计的时候，要分析需求的场景，比如说数据的量级是怎样的，请求的量级是怎样的，有没有一些可以利用的特点（比如系统通知未读场景下的有限共享存储、信息流未读场景下关注人数是有限的等等），然后再制定针对性的方案，切忌盲目使用之前的经验套用不同的场景，否则就可能造成性能的下降，甚至危害系统的稳定性。</p><h2 id="一课一思"><a aria-hidden="true" tabindex="-1" href="/blog-two/高并发系统设计40问/08.实战篇/02#一课一思"><span class="icon icon-link"></span></a>一课一思</h2><p>结合实际项目聊一聊在你的系统中有哪些未读计数的场景呢？你是如何设计方案来实现未读计数的呢？欢迎在留言区与我分享你的经验。</p><p>最后，感谢你的阅读，如果这篇文章让你有所收获，也欢迎你将它分享给更多的朋友。</p></div><div class="__dumi-default-layout-footer-meta"><a target="_blank" rel="noopener noreferrer" href="https://github.com/GGwujun/blog/edit/master/docs/高并发系统设计40问/08.实战篇/02.md">在 GitHub 上编辑此页<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><span data-updated-text="最后更新时间：">5/2/2022 02:41:08</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script>
      (function () {
        if (!location.port) {
          (function (i, s, o, g, r, a, m) {
            i["GoogleAnalyticsObject"] = r;
            (i[r] =
              i[r] ||
              function () {
                (i[r].q = i[r].q || []).push(arguments);
              }),
              (i[r].l = 1 * new Date());
            (a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
            a.async = 1;
            a.src = g;
            m.parentNode.insertBefore(a, m);
          })(
            window,
            document,
            "script",
            "//www.google-analytics.com/analytics.js",
            "ga"
          );
          ga("create", "UA-149864185-1", "auto");
          ga("send", "pageview");
        }
      })();
    </script>
    <script src="/blog-two/umi.js"></script>
  </body>
</html>
