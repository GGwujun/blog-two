<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="shortcut icon" type="image/x-icon" href="/logo.png" />
    <link rel="stylesheet" href="/blog-two/umi.css" />
    <script>
      window.routerBase = "/blog-two";
    </script>
    <script>
      //! umi version: 3.5.17
    </script>
    <script>
      !(function () {
        var e = localStorage.getItem("dumi:prefers-color"),
          t = window.matchMedia("(prefers-color-scheme: dark)").matches,
          r = ["light", "dark", "auto"];
        document.documentElement.setAttribute(
          "data-prefers-color",
          e === r[2] ? (t ? r[1] : r[0]) : r.indexOf(e) > -1 ? e : r[0]
        );
      })();
    </script>
    <title>18 | 可伸缩架构案例：数据太多，如何无限扩展你的数据库？</title>
  </head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-route="/架构实战案例解析/03.技术架构篇/08" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;/logo.png&#x27;)" href="/blog-two/">大师兄</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><span>后端开发<ul><li><a href="/blog-two/go语言核心36讲">go语言核心36讲</a></li><li><a href="/blog-two/go并发编程实战">go并发编程实战</a></li><li><a href="/blog-two/零基础学python">零基础学python</a></li><li><a href="/blog-two/redis核心技术与实战">redis核心技术与实战</a></li><li><a href="/blog-two/redis源码剖析与实战">redis源码剖析与实战</a></li><li><a href="/blog-two/陈天rust编程第一课">陈天rust编程第一课</a></li><li><a href="/blog-two/tonybaigo语言第一课">tonybaigo语言第一课</a></li><li><a href="/blog-two/深入c语言和程序运行原理">深入c语言和程序运行原理</a></li></ul></span><span>架构师<ul><li><a href="/blog-two/持续交付36讲">持续交付36讲</a></li><li><a href="/blog-two/容器实战高手课">容器实战高手课</a></li><li><a href="/blog-two/ddd实战课">ddd实战课</a></li><li><a href="/blog-two/设计模式之美">设计模式之美</a></li><li><a href="/blog-two/devops实战笔记">devops实战笔记</a></li><li><a aria-current="page" class="active" href="/blog-two/架构实战案例解析">架构实战案例解析</a></li><li><a href="/blog-two/许式伟的架构课">许式伟的架构课</a></li><li><a href="/blog-two/高并发系统设计40问">高并发系统设计40问</a></li><li><a href="/blog-two/深入剖析kubernetes">深入剖析kubernetes</a></li><li><a href="/blog-two/说透中台">说透中台</a></li><li><a href="/blog-two/消息队列进阶">消息队列进阶</a></li><li><a href="/blog-two/mysql实战45讲">mysql实战45讲</a></li><li><a href="/blog-two/openresty从入门到实战">openresty从入门到实战</a></li><li><a href="/blog-two/赵成的运维体系管理课">赵成的运维体系管理课</a></li><li><a href="/blog-two/性能测试实战30讲">性能测试实战30讲</a></li><li><a href="/blog-two/安全攻防技能30讲">安全攻防技能30讲</a></li><li><a href="/blog-two/从0开始学架构">从0开始学架构</a></li><li><a href="/blog-two/vim实用技巧必知必会">vim实用技巧必知必会</a></li><li><a href="/blog-two/如何落地业务建模">如何落地业务建模</a></li><li><a href="/blog-two/技术与商业案例解读">技术与商业案例解读</a></li><li><a href="/blog-two/说透数字化转型">说透数字化转型</a></li><li><a href="/blog-two/遗留系统现代化实战">遗留系统现代化实战</a></li></ul></span><span>管理<ul><li><a href="/blog-two/技术管理实战36讲">技术管理实战36讲</a></li><li><a href="/blog-two/程序员进阶攻略">程序员进阶攻略</a></li><li><a href="/blog-two/项目管理实战课">项目管理实战课</a></li><li><a href="/blog-two/技术面试官识人手册">技术面试官识人手册</a></li><li><a href="/blog-two/技术领导力实战笔记">技术领导力实战笔记</a></li><li><a href="/blog-two/朱赟的技术管理">朱赟的技术管理</a></li></ul></span><span>工作生活<ul><li><a href="/blog-two/10x程序员工作法">10x程序员工作法</a></li><li><a href="/blog-two/python自动化办公实战课">python自动化办公实战课</a></li><li><a href="/blog-two/人人都用得上的写作课">人人都用得上的写作课</a></li><li><a href="/blog-two/体验设计案例课">体验设计案例课</a></li><li><a href="/blog-two/用户体验设计实战课">用户体验设计实战课</a></li><li><a href="/blog-two/程序员的个人财富课">程序员的个人财富课</a></li><li><a href="/blog-two/程序员进阶攻略">程序员进阶攻略</a></li><li><a href="/blog-two/职场求生攻略">职场求生攻略</a></li><li><a href="/blog-two/讲好故事">讲好故事</a></li><li><a href="/blog-two/跟着高手学复盘">跟着高手学复盘</a></li></ul></span><span>杂谈</span><div class="__dumi-default-navbar-tool"><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "></div></div></div></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;/logo.png&#x27;)" href="/blog-two/"></a><h1>大师兄</h1><p></p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li>后端开发<ul><li><a href="/blog-two/go语言核心36讲">go语言核心36讲</a></li><li><a href="/blog-two/go并发编程实战">go并发编程实战</a></li><li><a href="/blog-two/零基础学python">零基础学python</a></li><li><a href="/blog-two/redis核心技术与实战">redis核心技术与实战</a></li><li><a href="/blog-two/redis源码剖析与实战">redis源码剖析与实战</a></li><li><a href="/blog-two/陈天rust编程第一课">陈天rust编程第一课</a></li><li><a href="/blog-two/tonybaigo语言第一课">tonybaigo语言第一课</a></li><li><a href="/blog-two/深入c语言和程序运行原理">深入c语言和程序运行原理</a></li></ul></li><li>架构师<ul><li><a href="/blog-two/持续交付36讲">持续交付36讲</a></li><li><a href="/blog-two/容器实战高手课">容器实战高手课</a></li><li><a href="/blog-two/ddd实战课">ddd实战课</a></li><li><a href="/blog-two/设计模式之美">设计模式之美</a></li><li><a href="/blog-two/devops实战笔记">devops实战笔记</a></li><li><a aria-current="page" class="active" href="/blog-two/架构实战案例解析">架构实战案例解析</a></li><li><a href="/blog-two/许式伟的架构课">许式伟的架构课</a></li><li><a href="/blog-two/高并发系统设计40问">高并发系统设计40问</a></li><li><a href="/blog-two/深入剖析kubernetes">深入剖析kubernetes</a></li><li><a href="/blog-two/说透中台">说透中台</a></li><li><a href="/blog-two/消息队列进阶">消息队列进阶</a></li><li><a href="/blog-two/mysql实战45讲">mysql实战45讲</a></li><li><a href="/blog-two/openresty从入门到实战">openresty从入门到实战</a></li><li><a href="/blog-two/赵成的运维体系管理课">赵成的运维体系管理课</a></li><li><a href="/blog-two/性能测试实战30讲">性能测试实战30讲</a></li><li><a href="/blog-two/安全攻防技能30讲">安全攻防技能30讲</a></li><li><a href="/blog-two/从0开始学架构">从0开始学架构</a></li><li><a href="/blog-two/vim实用技巧必知必会">vim实用技巧必知必会</a></li><li><a href="/blog-two/如何落地业务建模">如何落地业务建模</a></li><li><a href="/blog-two/技术与商业案例解读">技术与商业案例解读</a></li><li><a href="/blog-two/说透数字化转型">说透数字化转型</a></li><li><a href="/blog-two/遗留系统现代化实战">遗留系统现代化实战</a></li></ul></li><li>管理<ul><li><a href="/blog-two/技术管理实战36讲">技术管理实战36讲</a></li><li><a href="/blog-two/程序员进阶攻略">程序员进阶攻略</a></li><li><a href="/blog-two/项目管理实战课">项目管理实战课</a></li><li><a href="/blog-two/技术面试官识人手册">技术面试官识人手册</a></li><li><a href="/blog-two/技术领导力实战笔记">技术领导力实战笔记</a></li><li><a href="/blog-two/朱赟的技术管理">朱赟的技术管理</a></li></ul></li><li>工作生活<ul><li><a href="/blog-two/10x程序员工作法">10x程序员工作法</a></li><li><a href="/blog-two/python自动化办公实战课">python自动化办公实战课</a></li><li><a href="/blog-two/人人都用得上的写作课">人人都用得上的写作课</a></li><li><a href="/blog-two/体验设计案例课">体验设计案例课</a></li><li><a href="/blog-two/用户体验设计实战课">用户体验设计实战课</a></li><li><a href="/blog-two/程序员的个人财富课">程序员的个人财富课</a></li><li><a href="/blog-two/程序员进阶攻略">程序员进阶攻略</a></li><li><a href="/blog-two/职场求生攻略">职场求生攻略</a></li><li><a href="/blog-two/讲好故事">讲好故事</a></li><li><a href="/blog-two/跟着高手学复盘">跟着高手学复盘</a></li></ul></li><li>杂谈</li></ul><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "><button title="Dark theme" class="__dumi-default-dark-moon "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3854" width="22" height="22"><path d="M991.816611 674.909091a69.166545 69.166545 0 0 0-51.665455-23.272727 70.795636 70.795636 0 0 0-27.438545 5.585454A415.674182 415.674182 0 0 1 754.993338 698.181818c-209.594182 0-393.472-184.785455-393.472-395.636363 0-52.363636 38.539636-119.621818 69.515637-173.614546 4.887273-8.610909 9.634909-16.756364 14.103272-24.901818A69.818182 69.818182 0 0 0 384.631156 0a70.842182 70.842182 0 0 0-27.438545 5.585455C161.678429 90.298182 14.362065 307.898182 14.362065 512c0 282.298182 238.824727 512 532.38691 512a522.286545 522.286545 0 0 0 453.957818-268.334545A69.818182 69.818182 0 0 0 991.816611 674.909091zM546.679156 954.181818c-248.785455 0-462.941091-192-462.941091-442.181818 0-186.647273 140.637091-372.829091 300.939637-442.181818-36.817455 65.629091-92.578909 151.970909-92.578909 232.727273 0 250.181818 214.109091 465.454545 462.917818 465.454545a488.331636 488.331636 0 0 0 185.181091-46.545455 453.003636 453.003636 0 0 1-393.565091 232.727273z m103.656728-669.323636l-14.266182 83.781818a34.909091 34.909091 0 0 0 50.362182 36.770909l74.775272-39.563636 74.752 39.563636a36.142545 36.142545 0 0 0 16.174546 3.956364 34.909091 34.909091 0 0 0 34.210909-40.727273l-14.289455-83.781818 60.509091-59.345455a35.025455 35.025455 0 0 0-19.223272-59.578182l-83.61891-12.101818-37.376-76.101818a34.56 34.56 0 0 0-62.254545 0l-37.376 76.101818-83.618909 12.101818a34.909091 34.909091 0 0 0-19.246546 59.578182z m70.423272-64.698182a34.280727 34.280727 0 0 0 26.135273-19.083636l14.312727-29.090909 14.336 29.090909a34.257455 34.257455 0 0 0 26.135273 19.083636l32.046546 4.887273-23.272728 22.574545a35.234909 35.234909 0 0 0-10.007272 30.952727l5.46909 32.116364-28.625454-15.127273a34.490182 34.490182 0 0 0-32.302546 0l-28.695272 15.127273 5.469091-32.116364a35.141818 35.141818 0 0 0-9.984-30.952727l-23.272728-22.574545z" p-id="3855"></path></svg></button><button title="Light theme" class="__dumi-default-dark-sun "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4026" width="22" height="22"><path d="M915.2 476.16h-43.968c-24.704 0-44.736 16-44.736 35.84s20.032 35.904 44.736 35.904H915.2c24.768 0 44.8-16.064 44.8-35.904s-20.032-35.84-44.8-35.84zM512 265.6c-136.704 0-246.464 109.824-246.464 246.4 0 136.704 109.76 246.464 246.464 246.464S758.4 648.704 758.4 512c0-136.576-109.696-246.4-246.4-246.4z m0 425.6c-99.008 0-179.2-80.128-179.2-179.2 0-98.944 80.192-179.2 179.2-179.2S691.2 413.056 691.2 512c0 99.072-80.192 179.2-179.2 179.2zM197.44 512c0-19.84-19.136-35.84-43.904-35.84H108.8c-24.768 0-44.8 16-44.8 35.84s20.032 35.904 44.8 35.904h44.736c24.768 0 43.904-16.064 43.904-35.904zM512 198.464c19.776 0 35.84-20.032 35.84-44.8v-44.8C547.84 84.032 531.84 64 512 64s-35.904 20.032-35.904 44.8v44.8c0 24.768 16.128 44.864 35.904 44.864z m0 627.136c-19.776 0-35.904 20.032-35.904 44.8v44.736C476.096 940.032 492.16 960 512 960s35.84-20.032 35.84-44.8v-44.736c0-24.768-16.064-44.864-35.84-44.864z m329.92-592.832c17.472-17.536 20.288-43.072 6.4-57.024-14.016-14.016-39.488-11.2-57.024 6.336-4.736 4.864-26.496 26.496-31.36 31.36-17.472 17.472-20.288 43.008-6.336 57.024 13.952 14.016 39.488 11.2 57.024-6.336 4.8-4.864 26.496-26.56 31.296-31.36zM213.376 759.936c-4.864 4.8-26.56 26.624-31.36 31.36-17.472 17.472-20.288 42.944-6.4 56.96 14.016 13.952 39.552 11.2 57.024-6.336 4.8-4.736 26.56-26.496 31.36-31.36 17.472-17.472 20.288-43.008 6.336-56.96-14.016-13.952-39.552-11.072-56.96 6.336z m19.328-577.92c-17.536-17.536-43.008-20.352-57.024-6.336-14.08 14.016-11.136 39.488 6.336 57.024 4.864 4.864 26.496 26.56 31.36 31.424 17.536 17.408 43.008 20.288 56.96 6.336 14.016-14.016 11.264-39.488-6.336-57.024-4.736-4.864-26.496-26.56-31.296-31.424z m527.168 628.608c4.864 4.864 26.624 26.624 31.36 31.424 17.536 17.408 43.072 20.224 57.088 6.336 13.952-14.016 11.072-39.552-6.4-57.024-4.864-4.8-26.56-26.496-31.36-31.36-17.472-17.408-43.072-20.288-57.024-6.336-13.952 14.016-11.008 39.488 6.336 56.96z" p-id="4027"></path></svg></button><button title="Default to system" class="__dumi-default-dark-auto "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="11002" width="22" height="22"><path d="M127.658667 492.885333c0-51.882667 10.24-101.717333 30.378666-149.162666s47.786667-88.064 81.92-122.538667 75.093333-61.781333 122.538667-81.92 96.938667-30.378667 149.162667-30.378667 101.717333 10.24 149.162666 30.378667 88.405333 47.786667 122.88 81.92 61.781333 75.093333 81.92 122.538667 30.378667 96.938667 30.378667 149.162666-10.24 101.717333-30.378667 149.162667-47.786667 88.405333-81.92 122.88-75.093333 61.781333-122.88 81.92-97.28 30.378667-149.162666 30.378667-101.717333-10.24-149.162667-30.378667-88.064-47.786667-122.538667-81.92-61.781333-75.093333-81.92-122.88-30.378667-96.938667-30.378666-149.162667z m329.045333 0c0 130.048 13.994667 244.394667 41.984 343.381334h12.970667c46.762667 0 91.136-9.216 133.461333-27.306667s78.848-42.666667 109.568-73.386667 54.954667-67.242667 73.386667-109.568 27.306667-86.698667 27.306666-133.461333c0-46.421333-9.216-90.794667-27.306666-133.12s-42.666667-78.848-73.386667-109.568-67.242667-54.954667-109.568-73.386667-86.698667-27.306667-133.461333-27.306666h-11.605334c-28.672 123.562667-43.349333 237.909333-43.349333 343.722666z" p-id="11003"></path></svg></button></div></div></div><ul class="__dumi-default-menu-list"><li><a href="/blog-two/架构实战案例解析">架构实战案例解析</a></li><li><a href="/blog-two/架构实战案例解析/01.概述篇">01.概述篇</a><ul><li><a href="/blog-two/架构实战案例解析/01.概述篇/01"><span>开篇词 | 想吃透架构？你得看看真实、接地气的架构案例</span></a></li><li><a href="/blog-two/架构实战案例解析/01.概述篇/02"><span>01 | 架构的本质：如何打造一个有序的系统？</span></a></li></ul></li><li><a href="/blog-two/架构实战案例解析/02.业务架构篇">02.业务架构篇</a><ul><li><a href="/blog-two/架构实战案例解析/02.业务架构篇/01"><span>02 | 业务架构：作为开发，你真的了解业务吗？</span></a></li><li><a href="/blog-two/架构实战案例解析/02.业务架构篇/02"><span>03 | 可扩展架构：如何打造一个善变的柔性系统？</span></a></li><li><a href="/blog-two/架构实战案例解析/02.业务架构篇/03"><span>04 | 可扩展架构案例（一）：电商平台架构是如何演变的？</span></a></li><li><a href="/blog-two/架构实战案例解析/02.业务架构篇/04"><span>05 | 可扩展架构案例（二）：App服务端架构是如何升级的？</span></a></li><li><a href="/blog-two/架构实战案例解析/02.业务架构篇/05"><span>06 | 可扩展架构案例（三）：你真的需要一个中台吗？</span></a></li><li><a href="/blog-two/架构实战案例解析/02.业务架构篇/06"><span>07 | 可复用架构：如何实现高层次的复用？</span></a></li><li><a href="/blog-two/架构实战案例解析/02.业务架构篇/07"><span>08 | 可复用架构案例（一）：如何设计一个基础服务？</span></a></li><li><a href="/blog-two/架构实战案例解析/02.业务架构篇/08"><span>09 | 可复用架构案例（二）：如何对现有系统做微服务改造？</span></a></li><li><a href="/blog-two/架构实战案例解析/02.业务架构篇/09"><span>10 | 可复用架构案例（三）：中台是如何炼成的？</span></a></li></ul></li><li><a aria-current="page" class="active" href="/blog-two/架构实战案例解析/03.技术架构篇">03.技术架构篇</a><ul><li><a href="/blog-two/架构实战案例解析/03.技术架构篇/01"><span>11 | 技术架构：作为开发，你真的了解系统吗？</span></a></li><li><a href="/blog-two/架构实战案例解析/03.技术架构篇/02"><span>12 | 高可用架构：如何让你的系统不掉链子？</span></a></li><li><a href="/blog-two/架构实战案例解析/03.技术架构篇/03"><span>13 | 高可用架构案例（一）：如何实现O2O平台日订单500万？</span></a></li><li><a href="/blog-two/架构实战案例解析/03.技术架构篇/04"><span>14 | 高可用架构案例（二）：如何第一时间知道系统哪里有问题？</span></a></li><li><a href="/blog-two/架构实战案例解析/03.技术架构篇/05"><span>15 | 高可用架构案例（三）：如何打造一体化的监控系统？</span></a></li><li><a href="/blog-two/架构实战案例解析/03.技术架构篇/06"><span>16 | 高性能和可伸缩架构：业务增长，能不能加台机器就搞定？</span></a></li><li><a href="/blog-two/架构实战案例解析/03.技术架构篇/07"><span>17 | 高性能架构案例：如何设计一个秒杀系统？</span></a></li><li><a aria-current="page" class="active" href="/blog-two/架构实战案例解析/03.技术架构篇/08"><span>18 | 可伸缩架构案例：数据太多，如何无限扩展你的数据库？</span></a></li><li><a href="/blog-two/架构实战案例解析/03.技术架构篇/09"><span>19 | 综合案例：电商平台技术架构是如何演变的？</span></a></li></ul></li><li><a href="/blog-two/架构实战案例解析/04.总结篇">04.总结篇</a><ul><li><a href="/blog-two/架构实战案例解析/04.总结篇/01"><span>20 | 从务实的角度，给你架构设计的重点知识和学习路径</span></a></li><li><a href="/blog-two/架构实战案例解析/04.总结篇/02"><span>结束语 | 和你聊聊我的架构心路历程</span></a></li></ul></li><li><a href="/blog-two/架构实战案例解析/05.结课测试">05.结课测试</a><ul><li><a href="/blog-two/架构实战案例解析/05.结课测试/01"><span>结课测试 | “架构实战案例解析”100分试卷等你来挑战！</span></a></li></ul></li><li><a href="/blog-two/架构实战案例解析/summary">架构实战案例解析</a></li></ul></div></div><ul role="slug-list" class="__dumi-default-layout-toc"><li title="问题和解决思路" data-depth="2"><a href="/blog-two/架构实战案例解析/03.技术架构篇/08#问题和解决思路"><span>问题和解决思路</span></a></li><li title="分库策略" data-depth="2"><a href="/blog-two/架构实战案例解析/03.技术架构篇/08#分库策略"><span>分库策略</span></a></li><li title="分库维度怎么定？" data-depth="3"><a href="/blog-two/架构实战案例解析/03.技术架构篇/08#分库维度怎么定"><span>分库维度怎么定？</span></a></li><li title="数据怎么分？" data-depth="3"><a href="/blog-two/架构实战案例解析/03.技术架构篇/08#数据怎么分"><span>数据怎么分？</span></a></li><li title="分几个库？" data-depth="3"><a href="/blog-two/架构实战案例解析/03.技术架构篇/08#分几个库"><span>分几个库？</span></a></li><li title="分库带来的问题" data-depth="2"><a href="/blog-two/架构实战案例解析/03.技术架构篇/08#分库带来的问题"><span>分库带来的问题</span></a></li><li title="分库路由" data-depth="3"><a href="/blog-two/架构实战案例解析/03.技术架构篇/08#分库路由"><span>分库路由</span></a></li><li title="分页处理" data-depth="3"><a href="/blog-two/架构实战案例解析/03.技术架构篇/08#分页处理"><span>分页处理</span></a></li><li title="分库字段映射" data-depth="3"><a href="/blog-two/架构实战案例解析/03.技术架构篇/08#分库字段映射"><span>分库字段映射</span></a></li><li title="整体架构" data-depth="2"><a href="/blog-two/架构实战案例解析/03.技术架构篇/08#整体架构"><span>整体架构</span></a></li><li title="如何安全落地？" data-depth="2"><a href="/blog-two/架构实战案例解析/03.技术架构篇/08#如何安全落地"><span>如何安全落地？</span></a></li><li title="项目总结" data-depth="2"><a href="/blog-two/架构实战案例解析/03.技术架构篇/08#项目总结"><span>项目总结</span></a></li><li title="总结" data-depth="2"><a href="/blog-two/架构实战案例解析/03.技术架构篇/08#总结"><span>总结</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h1 id="18--可伸缩架构案例数据太多如何无限扩展你的数据库"><a aria-hidden="true" tabindex="-1" href="/blog-two/架构实战案例解析/03.技术架构篇/08#18--可伸缩架构案例数据太多如何无限扩展你的数据库"><span class="icon icon-link"></span></a>18 | 可伸缩架构案例：数据太多，如何无限扩展你的数据库？</h1><p>你好，我是王庆友。在<a target="_blank" rel="noopener noreferrer" href="https://time.geekbang.org/column/article/217152">第16讲<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>中，我和你介绍了很多可伸缩的架构策略和原则。那么今天，我会通过1号店订单水平分库的实际案例，和你具体介绍如何实现系统的可伸缩。</p><h2 id="问题和解决思路"><a aria-hidden="true" tabindex="-1" href="/blog-two/架构实战案例解析/03.技术架构篇/08#问题和解决思路"><span class="icon icon-link"></span></a>问题和解决思路</h2><p>2013年，随着1号店业务的发展，每日的订单量接近100万。这个时候，订单库已有上亿条记录，订单表有上百个字段，这些数据存储在一个Oracle数据库里。当时，我们已经实现了订单的服务化改造，只有订单服务才能访问这个订单数据库，但随着单量的增长以及在线促销的常态化，单一数据库的存储容量和访问性能都已经不能满足业务需求了，订单数据库已成为系统的瓶颈。所以，对这个数据库的拆分势在必行。</p><p>数据库拆分一般有两种做法，一个是垂直分库，还有一个是水平分库。</p><ul><li><strong>垂直分库</strong></li></ul><p>简单来说，垂直分库就是数据库里的表太多，我们把它们分散到多个数据库，一般是根据业务进行划分，把关系密切的表放在同一个数据库里，这个改造相对比较简单。</p><ul><li><strong>水平分库</strong></li></ul><p>某些表太大，单个数据库存储不下，或者数据库的读写性能有压力。通过水平分库，我们把一张表拆成多张表，每张表存放部分记录，分别保存在不同的数据库里，水平分库需要对应用做比较大的改造。</p><p><img src="https://static001.geekbang.org/resource/image/6a/81/6a414d387a08a6dc291c3a3a9e763c81.jpg" alt=""/></p><p>当时，1号店已经通过服务化，实现了订单库的<strong>垂直拆分</strong>，它的订单库主要包括订单基本信息表、订单商品明细表、订单扩展表。这里的问题不是表的数量太多，而是单表的数据量太大，读写性能差。所以，1号店通过<strong>水平分库</strong>，把这3张表的记录分到多个数据库当中，从而分散了数据库的存储和性能压力。</p><p>水平分库后，应用通过订单服务来访问多个订单数据库，具体的方式如下图所示：</p><p><img src="https://static001.geekbang.org/resource/image/7c/9f/7cf1df5c241cd515d5e89456d2a7f39f.jpg" alt=""/></p><p>原来的一个Oracle库被现在的多个MySQL库给取代了，每个MySQL数据库包括了1主1备2从，都支持读写分离，主备之间通过自带的同步机制来实现数据同步。所以，你可以发现，<strong>这个项目实际包含了水平分库和去Oracle两大改造目标。</strong></p><h2 id="分库策略"><a aria-hidden="true" tabindex="-1" href="/blog-two/架构实战案例解析/03.技术架构篇/08#分库策略"><span class="icon icon-link"></span></a>分库策略</h2><p>我们先来讨论一下水平分库的具体策略，包括要选择哪个分库维度，数据记录如何划分，以及要分为几个数据库。</p><h3 id="分库维度怎么定"><a aria-hidden="true" tabindex="-1" href="/blog-two/架构实战案例解析/03.技术架构篇/08#分库维度怎么定"><span class="icon icon-link"></span></a>分库维度怎么定？</h3><p>首先，我们需要考虑根据哪个字段来作为分库的维度。</p><p>这个字段选择的标准是，尽量避免应用代码和SQL性能受到影响。具体地说，就是现有的SQL在分库后，它的访问尽量落在单个数据库里，否则原来的单库访问就变成了多库扫描，不但SQL的性能会受到影响，而且相应的代码也需要进行改造。</p><p>具体到订单数据库的拆分，你可能首先会想到按照<strong>用户ID</strong>来进行拆分。这个结论是没错，但我们最好还是要有量化的数据支持，不能拍脑袋。</p><p>这里，最好的做法是，先收集所有SQL，挑选出WHERE语句中最常出现的过滤字段，比如说这里有三个候选对象，分别是用户ID、订单ID和商家ID，每个字段在SQL中都会出现三种情况：</p><ol><li>单ID过滤，比如说“用户ID=？”；</li><li>多ID过滤，比如“用户ID IN(?,?,?)”；</li><li>该ID不出现。</li></ol><p>最后，我们分别统计这三个字段的使用情况，假设共有500个SQL访问订单库，3个候选字段出现的情况如下：</p><p><img src="https://static001.geekbang.org/resource/image/26/9a/26480ace17c1629c24f5881f65f2fa9a.jpg" alt=""/></p><p>从这张表来看，结论非常明显，我们应该选择用户ID来进行分库。</p><p>不过，等一等，这<strong>只是静态分析</strong>。我们知道，每个SQL访问的频率是不一样的，所以，我们还要分析每个SQL的实际访问量。</p><p>在项目中，我们分析了Top15执行次数最多的SQL （它们占总执行次数85%，具有足够代表性），按照执行的次数，如果使用用户ID进行分库，这些SQL 85%会落到单个数据库，13%落到多个数据库，只有2%需要遍历所有的数据库。所以说，<strong>从SQL动态执行次数的角度来看</strong>，用户ID分库也明显优于使用其他两个ID进行分库。</p><p>这样，通过前面的量化分析，我们知道按照用户ID分库是最优的选择，同时也大致知道了分库对现有系统会造成多大影响。比如在这个例子中，85%的SQL会落到单个数据库，那么这部分的数据访问相对于不分库来说，执行性能会得到一定的优化，这样也解决了我们之前对分库是否有效果的疑问，坚定了分库的信心。</p><h3 id="数据怎么分"><a aria-hidden="true" tabindex="-1" href="/blog-two/架构实战案例解析/03.技术架构篇/08#数据怎么分"><span class="icon icon-link"></span></a>数据怎么分？</h3><p>好，分库维度确定了以后，我们如何把记录分到各个库里呢？</p><p>一般有两种数据分法：</p><ol><li><strong>根据ID范围进行分库</strong>，比如把用户ID为1 ~ 999的记录分到第一个库，1000 ~ 1999的分到第二个库，以此类推。</li><li><strong>根据ID取模进行分库</strong>，比如把用户ID mod 10，余数为0的记录放到第一个库，余数为1的放到第二个库，以此类推。</li></ol><p>这两种分法，各自存在优缺点，如下表所示：</p><p><img src="https://static001.geekbang.org/resource/image/3b/81/3bf9fb5fb9e1569cf4478c493c02f081.jpg" alt=""/></p><p>在实践中，为了运维方便，选择ID取模进行分库的做法比较多。同时为了数据迁移方便，一般分库的数量是按照倍数增加的，比如说，一开始是4个库，二次分裂为8个，再分成16个。这样对于某个库的数据，在分裂的时候，一半数据会移到新库，剩余的可以不用动。与此相反，如果我们每次只增加一个库，所有记录都要按照新的模数做调整。</p><p>在这个项目中，我们结合订单数据的实际情况，最后采用的是<strong>取模</strong>的方式来拆分记录。</p><p>**补充说明：**按照取模进行分库，每个库记录数一般比较均匀，但也有些数据库，存在超级ID，这些ID的记录远远超过其他ID。比如在广告场景下，某个大广告主的广告数可能占很大比例。如果按照广告主ID取模进行分库，某些库的记录数会特别多，对于这些超级ID，需要提供单独库来存储记录。</p><h3 id="分几个库"><a aria-hidden="true" tabindex="-1" href="/blog-two/架构实战案例解析/03.技术架构篇/08#分几个库"><span class="icon icon-link"></span></a>分几个库？</h3><p>现在，我们确定了记录要怎么分，但具体要分成几个数据库呢？</p><p>分库数量，首先和<strong>单库能处理的记录数</strong>有关。一般来说，MySQL单库超过了5000万条记录，Oracle单库超过了1亿条记录，DB的压力就很大（当然这也和字段数量、字段长度和查询模式有关系）。</p><p>在满足前面记录数量限制的前提下，如果分库的数量太少，我们达不到分散存储和减轻DB性能压力的目的；如果分库的数量太多，好处是单库访问性能好，但对于跨多个库的访问，应用程序需要同时访问多个库，如果我们并发地访问所有数据库，就意味着要消耗更多的线程资源；如果是串行的访问模式，执行的时间会大大地增加。</p><p>另外，分库数量还直接影响了<strong>硬件的投入</strong>，多一个库，就意味着要多投入硬件设备。所以，具体分多少个库，需要做一个综合评估，一般初次分库，我建议你分成4~8个库。在项目中，我们拆分为了6个数据库，这样可以满足较长一段时间的订单业务需求。</p><h2 id="分库带来的问题"><a aria-hidden="true" tabindex="-1" href="/blog-two/架构实战案例解析/03.技术架构篇/08#分库带来的问题"><span class="icon icon-link"></span></a>分库带来的问题</h2><p>不过水平分库解决了单个数据库容量和性能瓶颈的同时，也给我们带来了一系列新的问题，包括数据库路由、分页以及字段映射的问题。</p><h3 id="分库路由"><a aria-hidden="true" tabindex="-1" href="/blog-two/架构实战案例解析/03.技术架构篇/08#分库路由"><span class="icon icon-link"></span></a>分库路由</h3><p>分库从某种意义上来说，意味着DB Schema改变了，必然会影响应用，但这种改变和业务无关，所以我们要尽量保证分库相关的逻辑都在数据访问层进行处理，对上层的订单服务透明，服务代码无需改造。</p><p>当然，要完全做到这一点会很困难。那么具体哪些改动应该由DAL（数据访问层）负责，哪些由订单服务负责，这里我给你一些可行的建议：</p><ul><li>对于<strong>单库访问</strong>，比如查询条件已经指定了用户ID，那么该SQL只需访问特定库即可。此时应该由DAL层自动路由到特定库，当库二次分裂时，我们也只需要修改取模因子就可以了，应用代码不会受到影响。</li><li>对于<strong>简单的多库查询</strong>，DAL层负责汇总各个分库返回的记录，此时它仍对上层应用透明。</li><li>对于<strong>带聚合运算的多库查询</strong>，比如说带groupby、orderby、min、max、avg等关键字，建议可以让DAL层汇总单个库返回的结果，然后由上层应用做进一步的处理。这样做有两方面的原因，一方面是因为让DAL层支持所有可能的聚合场景，实现逻辑会很复杂；另一方面，从1号店的实践来看，这样的聚合场景并不多，在上层应用做针对性处理，会更加灵活。</li></ul><p>DAL层还可以进一步细分为<strong>底层JDBC驱动层</strong>和<strong>偏上面的数据访问层</strong>。如果我们基于JDBC层面实现分库路由，系统开发难度大，灵活性低，目前也没有很好的成功案例。</p><p>在实践中，我们一般是基于持久层框架，把它进一步封装成<strong>DDAL</strong>（Distributed Data Access Layer，分布式数据访问层），实现分库路由。1号店的DDAL就是基于iBatis进一步封装而来的。</p><h3 id="分页处理"><a aria-hidden="true" tabindex="-1" href="/blog-two/架构实战案例解析/03.技术架构篇/08#分页处理"><span class="icon icon-link"></span></a>分页处理</h3><p>水平分库后，分页查询的问题比较突出，因为有些分页查询需要遍历所有库。</p><p>举个例子，假设我们要按时间顺序展示某个商家的订单，每页有100条记录，由于是按商家查询，我们需要遍历所有数据库。假设库数量是8，我们来看下水平分库后的分页逻辑：</p><ul><li>如果是取第1页数据，我们需要从每个库里按时间顺序取前100条记录，8个库汇总后共有800条，然后我们对这800条记录在应用里进行二次排序，最后取前100条；</li><li>如果取第10页数据，则需要从每个库里取前1000（100*10）条记录，汇总后共有8000条记录，然后我们对这8000条记录进行二次排序后，取第900到1000之间的记录。</li></ul><p>你可以看到，在分库情况下，对于每个数据库，我们要取更多的记录，并且汇总后，还要在应用里做二次排序，越是靠后的分页，系统要耗费更多的内存和执行时间。而在不分库的情况下，无论取哪一页，我们只要从单个DB里取100条记录即可，也无需在应用内部做二次排序，非常简单。</p><p>**那么，我们如何解决分库情况下的分页问题呢？**这需要具体情况具体分析：</p><ul><li>如果是为前台应用提供分页，我们可以限定用户只能看到前面n页（这个限制在业务上也是合理的，一般看后面的分页意义不大，如果一定要看，可以要求用户缩小范围重新查询）；</li><li>如果是后台批处理任务要求分批获取数据，我们可以加大分页的大小，比如设定每次获取5000条记录，这样可以有效减少分页的访问次数；</li><li>分库设计时，一般还有配套的大数据平台负责汇总所有分库的记录，所以有些分页查询，我们可以考虑走大数据平台。</li></ul><h3 id="分库字段映射"><a aria-hidden="true" tabindex="-1" href="/blog-two/架构实战案例解析/03.技术架构篇/08#分库字段映射"><span class="icon icon-link"></span></a>分库字段映射</h3><p>分库字段只有一个，比如这里，我们用的是用户ID，如果给定用户ID，这个查询会落到具体的某个库。但我们知道，在订单服务里，根据<strong>订单ID</strong>查询的场景也很多见，不过由于订单ID不是分库字段，如果不对它做特殊处理，系统会盲目查询所有分库，从而带来不必要的资源开销。</p><p>所以，这里我们<strong>为订单ID和用户ID创建映射，保存在Lookup表里</strong>，我们就可以根据订单ID，找到相应的用户ID，从而实现单库定位。</p><p>Lookup表的记录数和订单库记录总数相等，但它只有2个字段，所以存储和查询性能都不是问题，这个表在单独的数据库里存放。在实际使用时，我们可以通过<strong>分布式缓存</strong>，来优化Lookup表的查询性能。此外，对于新增的订单，除了写订单表，我们同时还要写Lookup表。</p><h2 id="整体架构"><a aria-hidden="true" tabindex="-1" href="/blog-two/架构实战案例解析/03.技术架构篇/08#整体架构"><span class="icon icon-link"></span></a>整体架构</h2><p>通过以上分析，最终的1号店订单水平分库的总体技术架构如下图所示：</p><p><img src="https://static001.geekbang.org/resource/image/3a/9c/3ae46ab0d2d5430f03b436c87247d59c.jpg" alt=""/></p><ul><li><strong>上层应用</strong>通过订单服务访问数据库；</li><li><strong>分库代理</strong>实现了分库相关的功能，包括聚合运算、订单ID到用户ID的映射，做到分库逻辑对订单服务透明；</li><li><strong>Lookup表</strong>用于订单ID和用户ID的映射，保证订单服务按订单ID访问时，可以直接落到单个库，Cache是Lookup表数据的缓存；</li><li><strong>DDAL</strong>提供库的路由，可以根据用户ID定位到某个库，对于多库访问，DDAL支持可选的多线程并发访问模式，并支持简单的记录汇总；</li><li><strong>Lookup表初始化数据</strong>来自于现有的分库数据，当新增订单记录时，由分库代理异步写入。</li></ul><h2 id="如何安全落地"><a aria-hidden="true" tabindex="-1" href="/blog-two/架构实战案例解析/03.技术架构篇/08#如何安全落地"><span class="icon icon-link"></span></a>如何安全落地？</h2><p>订单表是系统的核心业务表，它的水平拆分会影响到很多业务，订单服务本身的代码改造也很大，很容易导致依赖订单服务的应用出现问题。我们在上线时，必须谨慎考虑。</p><p>所以，为了保证订单水平分库的总体改造可以安全落地，整个方案的实施过程如下：</p><ul><li>首先，实现Oracle和MySQL两套库并行，所有数据读写指向Oracle库，我们通过数据同步程序，把数据从Oracle拆分到多个MySQL库，比如说3分钟增量同步一次。</li><li>其次，我们选择几个对数据实时性要求不高的访问场景（比如访问历史订单），把订单服务转向访问MySQL数据库，以检验整套方案的可行性。</li><li>最后，经过大量测试，如果性能和功能都没有问题，我们再一次性把所有实时读写访问转向MySQL，废弃Oracle。</li></ul><p>这里，我们把上线分成了两个阶段：<strong>第一阶段</strong>，把部分非实时的功能切换到MySQL，这个阶段主要是为了<strong>验证技术</strong>，它包括了分库代理、DDAL、Lookup表等基础设施的改造；<strong>第二阶段</strong>，主要是<strong>验证业务功能</strong>，我们把所有订单场景全面接入MySQL。1号店两个阶段的上线都是一次性成功的，特别是第二阶段的上线，100多个依赖订单服务的应用，通过简单的重启就完成了系统的升级，中间没有出现一例较大的问题。</p><h2 id="项目总结"><a aria-hidden="true" tabindex="-1" href="/blog-two/架构实战案例解析/03.技术架构篇/08#项目总结"><span class="icon icon-link"></span></a>项目总结</h2><p>1号店在完成订单水平分库的同时，也实现了去Oracle，设备从小型机换成了X86服务器，我们通过水平分库和去Oracle，不但支持了订单量的未来增长，并且总体成本也大幅下降。</p><p>不过由于去Oracle和订单分库一起实施，带来了双重的性能影响，我们花了很大精力做性能测试。为了模拟真实的线上场景，我们通过<strong>TCPCopy</strong>，把线上实际的查询流量引到测试环境，先后经过13轮的性能测试，最终6个MySQL库相对一个Oracle，在当时的数据量下，SQL执行时间基本持平。这样，我们<strong>在性能不降低的情况下，通过水平分库优化了架构，实现了订单处理能力的水平扩展。</strong></p><p>1号店最终是根据用户ID后三位取模进行分库，初始分成了6个库，理论上可以支持多达768个库。同时我们还改造了订单ID的生成规则，使其包括用户ID后三位，这样新订单ID本身就包含了库定位所需信息，无需走Lookup映射机制。随着老订单归档到历史库，在前面给出的架构中，Lookup表相关的部分就可以逐渐废弃了。</p><p>如果要扩充数据库的数量，从6个升到12个，我们可以分三步走：</p><ol><li>增加6个MySQL实例，把现有6个库的数据同步到新的库，比如说，0号库同步到6号库，1号库同步到7号库等等；</li><li>在配置文件里把分库的取模从6变成12；</li><li>通过数据库脚本，每个库删掉一半数据，比如对于0号库，删掉用户ID%12=6的记录，对于6号库，删掉用户ID%12=0的记录。</li></ol><p>你可以看到，通过这样的分库方式，整个数据库扩展是非常容易的，不涉及复杂的数据跨库迁移工作。</p><p>订单的水平分库是一项系统性工作，需要大胆设计，谨慎实施。<strong>你需要把握住这几个要点：</strong></p><ul><li>首先，你需要在分库策略的指导下，结合实际情况，在每个方面做出最合适的选择；</li><li>其次，对于特殊场景，如分页查询，你需要具体问题具体解决；</li><li>最后，你要总体规划，控制好落地步骤，包括对系统改造、性能测试、数据迁移、上线实施等各个环节做好衔接，保证业务不出问题。</li></ul><h2 id="总结"><a aria-hidden="true" tabindex="-1" href="/blog-two/架构实战案例解析/03.技术架构篇/08#总结"><span class="icon icon-link"></span></a>总结</h2><p>今天我和你分享了1号店订单水平分库的实际案例，并给出了具体的做法和原因，相信你已经掌握了如何通过对数据库的水平拆分，来保证系统的高性能和可伸缩。</p><p><strong>水平分库是针对有状态的存储节点进行水平扩展</strong>，相对于无状态的节点，系统改造的复杂性比较高，要考虑的点也比较多。通过今天的分享，希望你以后在设计一个复杂方案时，能够更全面地思考相关的细节，提升架构设计能力。</p><p><strong>最后，给你留一道思考题</strong>：你公司的数据库有什么瓶颈吗，你计划对它做什么样的改造呢？</p><p>欢迎在留言区和我互动，我会第一时间给你反馈。如果这节课对你有帮助，也欢迎你把它分享给你的朋友。感谢阅读，我们下期再见。</p></div><div class="__dumi-default-layout-footer-meta"><a target="_blank" rel="noopener noreferrer" href="https://github.com/GGwujun/blog/edit/master/docs/架构实战案例解析/03.技术架构篇/08.md">在 GitHub 上编辑此页<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><span data-updated-text="最后更新时间：">5/2/2022 02:41:02</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script>
      (function () {
        if (!location.port) {
          (function (i, s, o, g, r, a, m) {
            i["GoogleAnalyticsObject"] = r;
            (i[r] =
              i[r] ||
              function () {
                (i[r].q = i[r].q || []).push(arguments);
              }),
              (i[r].l = 1 * new Date());
            (a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
            a.async = 1;
            a.src = g;
            m.parentNode.insertBefore(a, m);
          })(
            window,
            document,
            "script",
            "//www.google-analytics.com/analytics.js",
            "ga"
          );
          ga("create", "UA-149864185-1", "auto");
          ga("send", "pageview");
        }
      })();
    </script>
    <script src="/blog-two/umi.js"></script>
  </body>
</html>
